<!DOCTYPE html>
<html lang="en">
<head>
  <title>NFC Clone & Create App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    button { font-size: 1em; padding: 10px; margin: 5px 2px; cursor: pointer; border-radius: 5px; border: 1px solid #777; }
    #output, .saved-item, #writer-section { margin-top: 15px; border: 1px solid #ccc; padding: 10px; word-wrap: break-word; border-radius: 5px; }
    #writer-section { background-color: #eef; }
    .saved-item { background-color: #f9f9f9; }
    .log { color: #555; font-family: monospace; }
    .error { color: red; font-weight: bold; }
    textarea { width: 95%; min-height: 60px; font-family: monospace; }
    hr { border: 1px solid #eee; margin: 20px 0; }
  </style>
</head>
<body>

  <h1>Web NFC: Clone & Create</h1>
  
  <div id="scanner-section">
      <button id="scanButton">1. Scan Tag</button>
      <div id="saveControls" style="display: none;">
          <button id="saveButton">2. Save Last Scan</button>
      </div>
  </div>

  <div class="log">
    <p><b>Status:</b> <span id="status">Idle. Click 'Scan' to begin.</span></p>
    <p class="error" id="error"></p>
  </div>
  
  <div id="output"><p>Scan results appear here.</p></div>

  <hr>

  <div id="writer-section">
    <h2>Create a New Simple Tag</h2>
    <p>Use this for writing new text or URL data from scratch.</p>
    <textarea id="dataToCreate" placeholder="Enter text or a full URL (e.g., https://google.com)"></textarea><br>
    <label for="recordType">Record Type:</label>
    <select id="recordType">
      <option value="text" selected>Text</option>
      <option value="url">URL</option>
    </select>
    <button id="createButton">Create and Write Tag</button>
  </div>

  <hr>

  <h2>Saved Scans <button id="clearButton" style="font-size: 0.8em; float: right;">Clear Saved</button></h2>
  <div id="saved-scans">
    <p>No scans saved yet.</p>
  </div>

  <script>
    // --- DOM ELEMENT REFERENCES ---
    const scanButton = document.getElementById('scanButton');
    const saveButton = document.getElementById('saveButton');
    const createButton = document.getElementById('createButton');
    const clearButton = document.getElementById('clearButton');
    const saveControls = document.getElementById('saveControls');
    const statusSpan = document.getElementById('status');
    const outputDiv = document.getElementById('output');
    const errorDiv = document.getElementById('error');
    const savedScansDiv = document.getElementById('saved-scans');
    const dataToCreateText = document.getElementById('dataToCreate');
    const recordTypeSelect = document.getElementById('recordType');

    let lastScanResult = null;

    // --- UTILITY: ArrayBuffer to Hex String ---
    function toHexString(buffer) {
      return Array.from(new Uint8Array(buffer))
        .map(b => b.toString(16).padStart(2, '0').toUpperCase())
        .join('-');
    }

    // --- CLONE TAG FUNCTION (CORRECTED) ---
    async function cloneTag(scanData) {
        statusSpan.textContent = 'Preparing to clone...';
        errorDiv.textContent = '';
        
        // ** THE FIX IS HERE **
        // Create a valid array of NDEFRecordInit objects.
        // We manually construct each record to ensure it's valid.
        const recordsToWrite = scanData.records.map(savedRecord => {
            const recordInit = {
                recordType: savedRecord.recordType,
                data: new Uint8Array(savedRecord.data)
            };

            // Only add mediaType if the recordType is 'mime'.
            if (savedRecord.recordType === 'mime') {
                recordInit.mediaType = savedRecord.mediaType;
            }

            // Also handle other optional properties like 'id'.
            if (savedRecord.id) {
                recordInit.id = savedRecord.id;
            }
            
            return recordInit;
        });

        const messageToWrite = { records: recordsToWrite };

        try {
            const ndef = new NDEFReader();
            await ndef.write(messageToWrite);
            statusSpan.textContent = 'Clone successful! New tag has been written.';
        } catch (error) {
            statusSpan.textContent = 'Clone failed!';
            errorDiv.textContent = 'Error: ' + error;
        }
    }

    // --- RENDER SAVED SCANS ---
    function renderSavedScans() {
      const scans = JSON.parse(localStorage.getItem('nfcScans') || '[]');
      savedScansDiv.innerHTML = '';
      if (scans.length === 0) {
        savedScansDiv.innerHTML = '<p>No scans saved yet.</p>';
        return;
      }

      scans.forEach((scan) => {
        const item = document.createElement('div');
        item.className = 'saved-item';
        item.innerHTML = `<b>Saved:</b> ${new Date(scan.timestamp).toLocaleString()}<br>${scan.html}`;

        const cloneBtn = document.createElement('button');
        cloneBtn.textContent = 'Clone This Tag';
        cloneBtn.onclick = () => cloneTag(scan);

        item.appendChild(cloneBtn);
        savedScansDiv.appendChild(item);
      });
    }

    // --- BUTTON EVENT LISTENERS ---
    saveButton.addEventListener('click', () => {
      if (lastScanResult) {
        const scans = JSON.parse(localStorage.getItem('nfcScans') || '[]');
        scans.unshift(lastScanResult);
        localStorage.setItem('nfcScans', JSON.stringify(scans));
        renderSavedScans();
        statusSpan.textContent = 'Scan saved!';
      }
    });

    clearButton.addEventListener('click', () => {
      if(confirm('Are you sure you want to clear all saved scans?')) {
        localStorage.removeItem('nfcScans');
        renderSavedScans();
      }
    });

    createButton.addEventListener('click', async () => {
        statusSpan.textContent = 'Preparing to write...';
        errorDiv.textContent = '';
        const dataToWrite = dataToCreateText.value;
        if (!dataToWrite) {
            errorDiv.textContent = 'Error: Text box is empty.';
            return;
        }
        try {
            const ndef = new NDEFReader();
            await ndef.write({
                records: [{ recordType: recordTypeSelect.value, data: new TextEncoder().encode(dataToWrite) }]
            });
            statusSpan.textContent = 'Write successful!';
        } catch (error) {
            statusSpan.textContent = 'Write failed!';
            errorDiv.textContent = 'Error: ' + error;
        }
    });

    scanButton.addEventListener('click', async () => {
      statusSpan.textContent = 'Requesting permission...';
      outputDiv.innerHTML = '';
      errorDiv.textContent = '';
      saveControls.style.display = 'none';

      if (!('NDEFReader' in window)) {
        errorDiv.textContent = "Web NFC is not supported on this browser.";
        return;
      }

      try {
        const ndef = new NDEFReader();
        await ndef.scan();
        statusSpan.textContent = "Scan started. Bring a tag near your device...";

        ndef.addEventListener("readingerror", () => { statusSpan.textContent = "Error reading tag!"; });

        ndef.addEventListener("reading", ({ message, serialNumber }) => {
          statusSpan.textContent = "Tag read successfully!";
          saveControls.style.display = 'block';

          let html = `> Serial Number: ${serialNumber}<br>> Records: (${message.records.length})<hr>`;
          const rawRecords = [];

          for (const record of message.records) {
            html += `<b>ID:</b> ${record.id || 'N/A'}<br>`;
            html += `<b>Record Type:</b> ${record.recordType}<br>`;
            html += `<b>MIME Type:</b> ${record.mediaType || 'N/A'}<br>`;
            
            // Save a clean version of the record for cloning.
            rawRecords.push({
                id: record.id,
                recordType: record.recordType,
                mediaType: record.mediaType,
                data: Array.from(new Uint8Array(record.data))
            });

            if (record.recordType === 'text') {
              html += `<b>Data:</b> ${new TextDecoder(record.encoding).decode(record.data)}<br>`;
            } else if (record.recordType === 'url') {
              html += `<b>URL:</b> <a href="${new TextDecoder().decode(record.data)}" target="_blank">${new TextDecoder().decode(record.data)}</a><br>`;
            } else {
              html += `<b>Raw Data (Hex):</b> ${toHexString(record.data)}<br>`;
            }
            html += `<hr>`;
          }
          outputDiv.innerHTML = html;
          lastScanResult = { html: html, timestamp: new Date().getTime(), records: rawRecords };
        });
      } catch (error) {
        statusSpan.textContent = "Scan failed!";
        errorDiv.textContent = "Error: " + error;
      }
    });

    document.addEventListener('DOMContentLoaded', renderSavedScans);
  </script>

</body>
</html>
